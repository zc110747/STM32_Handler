# **单片机开发说明**
本篇将以STM32F429IGT6为例，讲解单片机中涉及的知识或者积累，对于单片机来说，涉及框架由以下部分组成:<br />
```
1.内核Core和配套的调试系统(如目前常用的Cortex-M0, M3, M4, M7等)，这部分由ARM来设计。
2.外设模块，包含SPI，I2C, CAN，SDIO, USB等，这些模块由专业的IP厂商或者芯片厂商设计开发，并通过各类总线(AHB, APB等)与Core进行连接实现具体功能。
3.存储器，包含FLASH，RAM，其中FLASH部分支持I-Cache和D-Cache进行加速。
4.时钟，电源管理和复位系统，管理上电时序和提供系统和模块工作的电压和Clock，模块间的同步，寄存器的读取和修改都依赖时钟的触发，这部分由模拟模块构建，并依赖数字模块控制，是芯片正常工作的基础。
```
## **1.内核概览**
芯片STM32F429IGT6基于Cortex-M4内核设计，包含以下特点:<br />
&emsp;&emsp;1.是32位的处理器内核，也就是说内部的寄存器和数据位宽都是32位的.<br />
&emsp;&emsp;2.采用哈佛结构，具有独立的数据总线和指令总线.<br />
&emsp;&emsp;3.支持MPU, 存储器保护单元, 可以控制对于不同memory的访问权限.<br />
&emsp;&emsp;4.支持DSP指令集, 能够加速浮点运算.<br />
&emsp;&emsp;5.支持handler和thread两种模式，分别用于表示异常服务例程和普通用户程序的代码，另外也支持特权分级，privileged和unprivileged模式, 其中handler模式只支持privileged模式.<br/>
### **1.1 通用寄存器**
Cortex-M4处理器拥有R0-R15寄存器组<br />
&emsp;&emsp;1.R0-R12为32位通用寄存器，用于数据操作。<br />
&emsp;&emsp;2.R13为堆栈指针寄存器，且同时指定两个堆栈指针:MSP(主堆栈指针)和PSP(进程堆栈指针)，并通过修改权限指向对应的堆栈指针，堆栈指针的最低两bit永远是0.<br />
&emsp;&emsp;3.R14为LR寄存器，主要在调用子程序时，存储返回地址.<br />
&emsp;&emsp;4.R15为PC寄存器，指向当前的程序地址.<br />
&emsp;&emsp;5.特殊功能寄存器xPSR,用于记录ALU标志，管理中断以及修改系统的特权状态.<br />
这些寄存器的相关知识，主要在实现RTOS或者在调试hardfault时追踪，对于RTOS中，汇编指令如下<br />
```s
    msr psp, r0	 #将psp指针值写入r0寄存器，并将当前堆栈切换到PSP
    msr msp, r0	 #将msp指针值写入r0寄存器，并将当前堆栈切换到MSP
```
对于触发hardfault时，可以使用错误追踪库，则包含对上述寄存器的运用:https://github.com/armink/CmBacktrace<br />

### **1.2 中断向量控制器NVIC**
Cortex-M4内核支持NVIC中断向量控制器，其中最大支持240个可编程中断(由芯片厂商定义)，另外包含15个系统中断，这部分声明在startup_xxx.s启动文件中，例如stm32f4的定义如下:<br />
```s
    DCD     __initial_sp               ; Top of Stack
    DCD     Reset_Handler              ; Reset Handler          #复位中断
    DCD     NMI_Handler                ; NMI Handler            #不可屏蔽中断
    DCD     HardFault_Handler          ; Hard Fault Handler     #硬fault中断
    DCD     MemManage_Handler          ; MPU Fault Handler      #MPU访问异常
    DCD     BusFault_Handler           ; Bus Fault Handler      #总线错误异常
    DCD     UsageFault_Handler         ; Usage Fault Handler    #程序错误异常
    DCD     0                          ; Reserved
    DCD     0                          ; Reserved
    DCD     0                          ; Reserved
    DCD     0                          ; Reserved
    DCD     SVC_Handler                ; SVCall Handler         #系统SVC异常
    DCD     DebugMon_Handler           ; Debug Monitor Handler  #调试监视器异常
    DCD     0                          ; Reserved
    DCD     PendSV_Handler             ; PendSV Handler         #为系统设置的PendSVSS异常
    DCD     SysTick_Handler            ; SysTick Handler        #系统滴答定时器异常
```

